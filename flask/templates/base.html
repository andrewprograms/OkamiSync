<!doctype html>
<html lang="en" data-bs-theme="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ config.get('APP_NAME', 'QR Ordering') }}{% block title %}{% endblock %}</title>
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0d6efd" />
  <link rel="icon" href="{{ url_for('static', filename='data/img/logo.svg') }}" />

  <!-- Bootstrap 5 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">

  <!-- jQuery, Lodash -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <!-- Dropzone (admin) & Chart.js (admin/staff) -->
  <script src="https://cdn.jsdelivr.net/npm/dropzone@6.0.0-beta.2/dist/dropzone-min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dropzone@6.0.0-beta.2/dist/dropzone.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Early theme boot (avoid FOUC) -->
  <script>
    (function () {
      try {
        const saved = localStorage.getItem('theme') || 'auto';
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const mode = saved === 'auto' ? (prefersDark ? 'dark' : 'light') : saved;
        document.documentElement.setAttribute('data-bs-theme', mode);
      } catch { }
    })();
  </script>

  <!-- PWA registration -->
  <script defer src="{{ url_for('static', filename='js/pwa.js') }}"></script>

  {% block head %}{% endblock %}
</head>

<body class="bg-body-tertiary">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand fw-semibold" href="/">QR Ordering</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"
        aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="nav" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          {% if current_user.is_authenticated %}
          <li class="nav-item"><span class="navbar-text me-3">Hi, {{ current_user.name }}</span></li>
          {% if current_user.role.value in ['staff','admin'] %}
          <li class="nav-item"><a class="nav-link" href="/staff/"><i class="bi bi-stack"></i> Staff</a></li>
          {% endif %}
          {% if current_user.role.value == 'admin' %}
          <li class="nav-item"><a class="nav-link" href="/admin/"><i class="bi bi-gear"></i> Admin</a></li>
          {% endif %}
          <li class="nav-item"><a class="nav-link" href="/logout"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
          {% else %}
          <li class="nav-item"><a class="nav-link" href="/login"><i class="bi bi-person"></i> Diner Login</a></li>
          <li class="nav-item"><a class="nav-link" href="/register"><i class="bi bi-person-plus"></i> Register</a></li>
          <li class="nav-item"><a class="nav-link" href="/staff/login"><i class="bi bi-clipboard2-check"></i> Staff</a>
          </li>
          <li class="nav-item"><a class="nav-link" href="/admin/login"><i class="bi bi-shield-lock"></i> Admin</a></li>
          {% endif %}
          <li class="nav-item ms-lg-3">
            <button id="themeToggle" class="btn btn-outline-light btn-sm" type="button" title="Toggle theme">
              <i class="bi bi-sun-fill me-1 d-none" id="icon-sun"></i>
              <i class="bi bi-moon-stars-fill me-1 d-none" id="icon-moon"></i>
              <span class="d-none d-lg-inline">Theme</span>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container-lg py-3">
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="alert alert-warning shadow-sm">{{ messages[0] }}</div>
    {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </main>

  <!-- Toast container -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toast-container" style="z-index: 1080;"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Theme toggle + icon swap
    (function () {
      const doc = document.documentElement;
      const btn = document.getElementById('themeToggle');
      const iSun = document.getElementById('icon-sun');
      const iMoon = document.getElementById('icon-moon');

      function getMode() {
        const saved = localStorage.getItem('theme') || 'auto';
        if (saved === 'auto') {
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        return saved;
      }
      function setMode(mode) {
        doc.setAttribute('data-bs-theme', mode);
        localStorage.setItem('theme', mode);
        iSun.classList.toggle('d-none', mode === 'light');
        iMoon.classList.toggle('d-none', mode !== 'light');
      }
      function init() { setMode(getMode()); }
      btn && btn.addEventListener('click', () => setMode(getMode() === 'light' ? 'dark' : 'light'));
      init();
    })();

    // Global toast helper
    window.showToast = function (message, variant = 'primary', delay = 2200) {
      try {
        const wrap = document.getElementById('toast-container');
        const el = document.createElement('div');
        el.className = `toast align-items-center text-bg-${variant} border-0 shadow`;
        el.role = 'status';
        el.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
        wrap.appendChild(el);
        const t = new bootstrap.Toast(el, { delay });
        t.show();
        el.addEventListener('hidden.bs.toast', () => el.remove());
      } catch { alert(message); }
    };
  </script>

  {% block scripts %}{% endblock %}
</body>

</html>